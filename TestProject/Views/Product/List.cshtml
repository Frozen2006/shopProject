@using BLL
@model TestProject.Models.ProductListModel

@Html.Action("CategoryNavigation", "Category", new { category = Model.Category })

@if (Model.Products.Count() != 0)
{  
<div class="products"> 
    <h3>Products</h3>

    <div id="sort_panel">
        <select id="sort" onchange="jsFunction()">
            <option>Alphabetic ascending</option>      
            <option>Alphabetic descending</option> 
            <option>Price ascending</option>                 
            <option>Price descending</option>            
        </select>

        <script>
            function jsFunction() {

                var params = {
                    categoryId: "@Model.Category.Id",
                    sort: "@Model.SortType",
                    pageSize: "@Model.PageSize",
                    reverse: "@Model.Reverse"
                }

                var select = document.getElementById("sort");

                switch (select.selectedIndex) {
                    case 0:
                        params.sort = "Alphabetic";
                        params.reverse = "False";
                        break;
                    case 1:
                        params.sort = "Alphabetic";
                        params.reverse = "True";
                        break;
                    case 2:
                        params.sort = "Price";
                        params.reverse = "False";
                        break;
                    case 3:
                        params.sort = "Price";
                        params.reverse = "True";
                        break;
                }
       
                window.location.href = "/product/list?" + $.param(params);  
            }
        </script>

        @for (int i = 1; i < 4; i++)
        {
            int size = (int)Math.Pow(10, i);
                @Html.ActionLink("Show by " + size, "List", new { categoryId = Model.Category.Id, sort = Model.SortType, pageSize = size, reverse = Model.Reverse }, new { @class = "btn" })
        }
    </div>      


@foreach(var product in Model.Products)
{
    <div class="well product_box">
        @{
            string href = "/product/details/" + product.Id;
            string path = "/Image/ProductImg/" + product.Id;
            
            <div class="info">
                <a class="no_underline" href="@href">
                    <img class="product_photo" width="70" height="70" src="@path" />
                </a>
                <a href="@href">
                    @product.Name
                </a>
            </div>
                
            <div class="tocart">
                <span>Price:</span>
                @product.Price
                @Html.Partial("../Counter", product.Id)  
            </div>
        }     
    </div>
}

@{
    int pageSize = Model.PageSize;
    int productCount = Model.Category.Products.Count();
    const int maxPageCount = 15;

    int pageCount = productCount / pageSize + 1;
}

    <div class="pagination pagination-centered">
        <ul>
        @if (pageCount >= maxPageCount)
        {
            const int linkCount = 6;

            for (int i = 1; i <= linkCount; i++)
            {
                <li>
                    @Html.ActionLink(i.ToString(), "List", new { categoryId = Model.Category.Id, page = i, sort = Model.SortType, pageSize = Model.PageSize, reverse = Model.Reverse })
                </li>
            }      

            <li class="disabled">...</li>

                    
            for (int i = pageCount - linkCount; i <= pageCount; i++)
            {
                <li>
                    @Html.ActionLink(i.ToString(), "List", new { categoryId = Model.Category.Id, page = i, sort = Model.SortType, pageSize = Model.PageSize, reverse = Model.Reverse })
                </li>
            }
        }

        @if (pageCount > 1 && pageCount < maxPageCount)
        {
            //View all page anchors

            for (int i = 1; i <= pageCount; i++)
            {
                <li>
                    @Html.ActionLink(i.ToString(), "List", new { categoryId = Model.Category.Id, page = i, sort = Model.SortType, pageSize = Model.PageSize, reverse = Model.Reverse })
                </li>
            }
        }
        </ul>
    </div>
</div>
}

<div id="alert-area" style="position: fixed; top: 200px; left: 50%; width: 500px;"></div>

<script>
    function newAlert(type, message) {
        $("#alert-area").append($("<div class='alert-message " + type + " fade in' data-alert><p> " + message + " </p></div>"));
        $(".alert-message").delay(2000).fadeOut("slow", function () { $(this).remove(); });
    }

    function getCounter(element) {
        return element.parentNode.getElementsByClassName("counter")[0];
    }

    function increase(event) {
        var counter = getCounter(event.target);
        var count = parseInt(counter.innerHTML);
        count += 1;

        counter.innerHTML = count;
    }

    function decrease(event) {
        var counter = getCounter(event.target);
        var count = parseInt(counter.innerHTML);

        if (count > 1) {
            count -= 1;
            counter.innerHTML = count;
        }
    }

    //public ActionResult AddToCart(int productId, int count)
    function sendRequest(id, c) {
        $.ajax
        ({
            url: "/Category/AddToCart",
            data: { productId: id, count: c },
            type: "POST",
            success: function (data) {
                newAlert('alert', data);
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert(textStatus);
            }
        })
    }

    function addToCart(event, productId) {
        var counter = getCounter(event.target);
        var count = parseInt(counter.innerHTML);

        sendRequest(productId, count);
    }
</script>